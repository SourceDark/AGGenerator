/**
 * Created by Nettle on 2017/2/22.
 */

(function () {
    'use strict';

    angular.module('BlurAdmin.pages.vulnerability', [
        'BlurAdmin.pages.vulnerability.detail'
    ])
        .config(routeConfig)
        .controller('vulnerabilityCtrl', function($scope,$http) {
            $scope.networkId = 1;
            $scope.apiUrl = 'http://162.105.30.200:9016';

            // TODO
            $http
                .get([$scope.apiUrl, 'server', $scope.networkId, 'vulnerabilities'].join('/'))
                .then(function (result) {
                    $scope.vulnerabilities = result.data;
                }, function (result) {
                    console.error('获取漏洞列表失败');
                });
        })
        .filter('cut', function () {
            return function (value, wordwise, max, tail) {
                if (!value) return '';

                max = parseInt(max, 10);
                if (!max) return value;
                if (value.length <= max) return value;

                value = value.substr(0, max);
                if (wordwise) {
                    var lastspace = value.lastIndexOf(' ');
                    if (lastspace != -1) {
                        value = value.substr(0, lastspace);
                    }
                }

                return value + (tail || ' …');
            };
        }).filter('unique', function() {
        return function(collection, keyname) {
            var output = [],
                keys = [];

            angular.forEach(collection, function(item) {
                var key = item[keyname];
                if(keys.indexOf(key) === -1) {
                    keys.push(key);
                    output.push(item);
                }
            });

            return output;
        };
    });
    /** @ngInject */
    function routeConfig($stateProvider) {
        $stateProvider
            .state('vulnerability', {
                url: '/vulnerability',
                templateUrl: 'app/pages/vulnerability/vulnerability.html',
                title: '缺陷',
                sidebarMeta: {
                    icon: 'ion-bug',
                    order: 1
                }
            })
    }

})();